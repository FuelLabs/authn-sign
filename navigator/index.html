<html>
    <head>
        <title>Authn-Sign Demo</title>
    </head>
    <body>
        <script type="module">
            import Account, {
                simulate_onchain_verification,
                hexToBase64, 
                bufferToHex,
                sha256,
                toBuffer,
                parseHexString,
                concatHexStrings,
                encode_signature,
            } from "./authn-sign.js";
            import buildPredicate, { setData, types } from './index.fuel.js';
        
            // Setup the GraphQL provider.
            const provider = await types.Provider.create('https://beta-4.fuel.network/graphql');

            // Account.
            const account = new Account();
            let details = {};
            let address = {};
            let predicate = null;

            // Set the challenge (this should be the tx ID in the future.).
            const challenge = '0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';
            
            // Register.
            document.querySelector('#register').addEventListener('click', async () => {
                await account.register('account_1');

                // Set details.
                details = {
                    publicKey: account.publicKeyCompact,
                    address: await account.address(),
                    id: account.id,
                };

                // Build the predicate.
                predicate = buildPredicate(provider, details.address);

                // Get the Fuel address.
                address = {
                    fuel: predicate.address,
                    hex: predicate.address.toHexString(),
                };

                // Write to result.
                document.querySelector('#result').innerHTML += "<h3>Key Information:</h3> <pre><code>" + JSON.stringify(details, null, 2) + '</code></pre>';

                // Write to result.
                document.querySelector('#result').innerHTML += "<h3>Fuel Account:</h3> <pre><code>" + JSON.stringify(address, null, 2) + '</code></pre>';
            });

            document.querySelector('#faucet').addEventListener('click', async () => {
                if (address.fuel) {
                    window.open("https://faucet-beta-4.fuel.network/?address=" + address.fuel);
                }
            });

            document.querySelector('#sign').addEventListener('click', async () => {
                // Sign the challenge.
                const signature = await account.sign(challenge);

                // Write to result.
                document.querySelector('#result').innerHTML += "<h3>Signature:</h3> <pre><code>" + JSON.stringify(signature, null, 2) + '</code></pre>';

                // Check EIP-2098.
                const check_eip2098 = await simulate_onchain_verification(
                    account.publicKey,
                    account.publicKeyCompact,
                    details.address,
                    signature.authenticatorData,
                    signature.clientData.preChallengeEncoded,
                    challenge,
                    signature.clientData.postChallengeEncoded,
                    signature.normalized,
                );

                // Verify check.
                const check_normal = account.verify(signature.message, signature.signature);

                // Write to result.
                document.querySelector('#result').innerHTML += `<h3>Signature:</h3> <pre><code>Verify on EIP-2098 ${check_eip2098} and P-256 ${check_normal}</code></pre>`;

                // Set the predicate data.
                setData(
                    predicate,
                    signature.normalized,
                    signature.authenticatorData,
                    challenge,
                    signature.clientData.preChallengeEncoded,
                    signature.clientData.postChallengeEncoded,
                );

                // Write to result.
                document.querySelector('#result').innerHTML += `<h3>Transact:</h3> <pre><code>Attempting to send 500 units of Ether to yourself.</code></pre>`;

                // Prepare the transaction.
                const tx = await predicate
                    .transfer(predicate.address, 500, types.BaseAssetId, {
                        gasPrice: 1,
                        gasLimit: 3_500_000,
                    });

                // Log it.
                console.log(tx);

                // Write to result.
                document.querySelector('#result').innerHTML += `<h3>Transact:</h3> <pre><code>${JSON.stringify(await tx.waitForResult(), null, 2)}</code></pre>`;
            });
        </script>
        <button id="register">Register</button>
        <button id="faucet">Faucet</button>
        <button id="sign">Sign</button>

        <div id="result"></div>
    </body>
</html>