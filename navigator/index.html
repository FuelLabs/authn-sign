<html>
    <head>
        <title>Authn-Sign Demo</title>
    </head>
    <body>
        <script type="module">
            import Account, {
                simulate_onchain_verification,
                hexToBase64, 
                bufferToHex,
                sha256,
                toBuffer,
                parseHexString,
                concatHexStrings
            } from "./authn-sign.js";
            import build_and_try from './index.fuel.js';

            (async () => {
                await build_and_try();

                const account = new Account(
                    /*
                    'account_1',
                    '0xde73483f049d4af92050eee9a84221268a7a81122d4e8023784758edbdd9bf01',
                    '0x048292dd5ee3865e2a0b122eb142286dde6fd8e28cd34803bf3d1b68c2a9ddea919217ba43acc469c74b61be70d154b8b65b0e970d8cf075db868d76b8c2a73be0'
                    */
                );

                await account.register('account_1');

                const details = {
                    publicKey: account.publicKeyCompact,
                    address: await account.address(),
                    id: account.id,
                };

                // Write to result.
                document.querySelector('#result').innerHTML += "<h3>Account:</h3> <pre><code>" + JSON.stringify(details, null, 2) + '</code></pre>';

                const challenge = '0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';

                const signature = await account.sign(challenge);

                // Write to result.
                document.querySelector('#result').innerHTML += "<h3>Signature:</h3> <pre><code>" + JSON.stringify(signature, null, 2) + '</code></pre>';

                // Check EIP-2098.
                const check_eip2098 = await simulate_onchain_verification(
                    account.publicKey,
                    account.publicKeyCompact,
                    details.address,
                    signature.authenticatorData,
                    signature.clientData.preChallengeEncoded,
                    challenge,
                    signature.clientData.postChallengeEncoded,
                    signature.normalized,
                );

                // Verify check.
                const check_normal = account.verify(signature.message, signature.signature);

                // Write to result.
                document.querySelector('#result').innerHTML += `<h3>Signature:</h3> <pre><code>Verify on EIP-2098 ${check_eip2098} and P-256 ${check_normal}</code></pre>`;
            })()
            .then(() => {})
            .catch(error => {
                document.querySelector('#result').innerHTML += `<h3>Error:</h3> <pre><code>${JSON.stringify(error, null, 2)}</code></pre>`;
            });
        </script>
        <div id="result"></div>
    </body>
</html>